<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/robut.ico">

        <title>Producers - Maxwell's Daemon</title>

        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/bootstrap-theme.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/prettify-1.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.5.2/respond.min.js"></script>
        <![endif]-->
        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Maxwell's Daemon</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Overview</a>
                </li>
            
            
            
                <li >
                    <a href="../quickstart/">Quick Start</a>
                </li>
            
            
            
                <li >
                    <a href="../config/">Configuration</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Producers</a>
                </li>
            
            
            
                <li >
                    <a href="../dataformat/">Data Format</a>
                </li>
            
            
            
                <li >
                    <a href="../bootstrapping/">Bootstrapping</a>
                </li>
            
            
            
                <li >
                    <a href="../compat/">Compat / Caveats</a>
                </li>
            
            
            
                <li >
                    <a href="../changelog/">Changelog</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../config/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../dataformat/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
            <div class="navbar-image-container"><img id="navbar-image" src="/img/maxwell_equals_2.png"></div>
        </div>
    </div>
</div>

        <a href="https://github.com/zendesk/maxwell"><img id="github-banner" style="position: absolute; top: 0; right: 0; border: 0; z-index: 1031;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
        <div class="container">
            <div class="col-md-2">&nbsp;<div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        
          <li >
              <a href="..">Overview</a>
              
          </li>
        
          <li >
              <a href="../quickstart/">Quick Start</a>
              
          </li>
        
          <li >
              <a href="../config/">Configuration</a>
              
          </li>
        
          <li class="active">
              <a href="./">Producers</a>
              
                  <ul class="nav">
                  
                      <li class="toctree-l3"><a href="#kafka-options">Kafka options</a></li>
                      
                  
                      <li class="toctree-l3"><a href="#kafka-topic">Kafka topic</a></li>
                      
                  
                      <li class="toctree-l3"><a href="#kafka-key">Kafka key</a></li>
                      
                  
                      <li class="toctree-l3"><a href="#kafka-partitioning">Kafka Partitioning</a></li>
                      
                  
                      <li class="toctree-l3"><a href="#kafka-client-version">Kafka client version</a></li>
                      
                  
                      <li class="toctree-l3"><a href="#kinesis-aws-credentials">Kinesis AWS credentials</a></li>
                      
                  
                      <li class="toctree-l3"><a href="#kinesis-options">Kinesis Options</a></li>
                      
                  
                  </ul>
              
          </li>
        
          <li >
              <a href="../dataformat/">Data Format</a>
              
          </li>
        
          <li >
              <a href="../bootstrapping/">Bootstrapping</a>
              
          </li>
        
          <li >
              <a href="../compat/">Compat / Caveats</a>
              
          </li>
        
          <li >
              <a href="../changelog/">Changelog</a>
              
          </li>
        
    </ul>
</div></div>
            <div class="col-md-10" role="main">

<h3 id="kafka-options">Kafka options</h3>
<hr />
<p>Any options given to Maxwell that are prefixed with <code>kafka.</code> will be passed directly into the Kafka producer configuration
(with <code>kafka.</code> stripped off).  We use the "new producer" configuration, as described here:
<a href="http://kafka.apache.org/documentation.html#newproducerconfigs">http://kafka.apache.org/documentation.html#newproducerconfigs</a></p>
<p>Here's some decent kafka properties. You can set them in <code>config.properties</code>.</p>
<pre><code>kafka.acks = 1
kafka.compression.type = snappy
kafka.metadata.fetch.timeout.ms=5000
kafka.retries=0
</code></pre>

<p>Note that these settings are optimized for throughput rather than full
consistency.  For at-least-once delivery, you will want something more like:</p>
<pre><code>kafka.acks = all
kafka.retries = 5 # or some larger number
</code></pre>

<p>And you will also want to set <code>min.insync.replicas</code> on Maxwell's output topic.</p>
<h3 id="kafka-topic">Kafka topic</h3>
<hr />
<p>Maxwell writes to a kafka topic named "maxwell" by default. It can be static,
e.g. 'maxwell', or dynamic, e.g. <code>namespace_%{database}_%{table}</code>. In the
latter case 'database' and 'table' will be replaced with the values for the row
being processed. This can be changed with the <code>kafka_topic</code> option.</p>
<h3 id="kafka-key">Kafka key</h3>
<hr />
<p>Maxwell generates keys for its Kafka messages based upon a mysql row's primary key in JSON format:</p>
<pre><code>{ &quot;database&quot;:&quot;test_tb&quot;,&quot;table&quot;:&quot;test_tbl&quot;,&quot;pk.id&quot;:4,&quot;pk.part2&quot;:&quot;hello&quot;}
</code></pre>

<p>This key is designed to co-operate with Kafka's log compaction, which will save the last-known
value for a key, allowing Maxwell's Kafka stream to retain the last-known value for a row and act
as a source of truth.</p>
<h3 id="kafka-partitioning">Kafka Partitioning</h3>
<hr />
<p>A binlog event's partition is determined by the selected hash function and hash string as follows</p>
<pre><code>  HASH_FUNCTION(HASH_STRING) % TOPIC.NUMBER_OF_PARTITIONS
</code></pre>

<p>The HASH_FUNCTION is either java's <em>hashCode</em> or <em>murmurhash3</em>. The default
HASH_FUNCTION is <em>hashCode</em>. Murmurhash3 may be set with the
<code>kafka_partition_hash</code> option. The seed value for the murmurhash function is
hardcoded to 25342 in the MaxwellKafkaPartitioner class.</p>
<p>The HASH_STRING may be (<em>database</em>, <em>table</em>, <em>primary_key</em>, <em>column</em>).  The
default HASH_STRING is the <em>database</em>. The partitioning field can be configured
using the <code>producer_partition_by</code> option.</p>
<p>When using <code>producer_partition_by</code>=<em>column</em> you must set
<code>producer_partition_columns</code> with the column name(s) to partition by (e.g.
<code>producer_partition_columns</code>=user_id or
<code>producer_partition_columns</code>=user_id,create_date). You must also set
<code>kafka_partiton_by_fallback</code>. This may be (<em>database</em>, <em>table</em>, <em>primary_key</em>).
It is used when the column(s) specified does not exist in the current row. The
default is <em>database</em>.  When partitioning by <em>column</em> Maxwell will treat the
values for the specified columns as strings, concatenate them and use that
value to partition the data. The above example, partitioning by user_id +
create_date would have a partition key similar to <em>1178532016-10-10 18:29:04</em>.</p>
<p>Maxwell will discover the number of partitions in its kafka topic upon boot.  This means that you should pre-create your kafka topics,
and with at least as many partitions as you have logical databases:</p>
<pre><code>bin/kafka-topics.sh --zookeeper ZK_HOST:2181 --create \
                    --topic maxwell --partitions 20 --replication-factor 2
</code></pre>

<p><a href="http://kafka.apache.org/documentation.html#quickstart">http://kafka.apache.org/documentation.html#quickstart</a></p>
<h3 id="kafka-client-version">Kafka client version</h3>
<hr />
<p>By default, maxwell runs with kafka clients 0.9.0.1. There is a flag (--kafka_version) that allows maxwell to run with either 0.8.2.2, 0.9.0.1, 0.10.0.1 or 0.10.1.0.
Noteables:
- Kafka clients 0.9.0.1 are not compatible with brokers running kafka 0.8. The exception below will show in logs when that is the case:</p>
<pre><code>ERROR Sender - Uncaught error in kafka producer I/O thread:
SchemaException: Error reading field 'throttle_time_ms': java.nio.BufferUnderflowException
</code></pre>

<ul>
<li>Kafka clients 0.8 and 0.9 are compatible with brokers running kafka 0.8.</li>
<li>0.10.0.x clients only support 0.10.0.x or later brokers.</li>
<li>Mixing Kafka 0.10 with other versions can lead to serious performance impacts.
  For More details, <a href="http://kafka.apache.org/0100/documentation.html#upgrade_10_performance_impact">read about it here</a>.</li>
</ul>
<hr />
<h3 id="kinesis-aws-credentials">Kinesis AWS credentials</h3>
<hr />
<p>You will need to obtain an IAM user that has the permission "kinesis:PutRecord" for the stream you are planning on producing to.
See the <a href="http://docs.aws.amazon.com/streams/latest/dev/controlling-access.html#kinesis-using-iam-examples">AWS docs</a> for the latest examples on which permissions are needed.</p>
<p>The producer uses the <a href="http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html">DefaultAWSCredentialsProviderChain</a> class to gain aws credentials.
See the <a href="http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/credentials.html">AWS docs</a> on how to setup the IAM user with the Default Credential Provider Chain.</p>
<h3 id="kinesis-options">Kinesis Options</h3>
<hr />
<p>Set the output stream in <code>config.properties</code> by setting the <code>kinesis_stream</code> property.</p>
<p>The producer uses the <a href="http://docs.aws.amazon.com/streams/latest/dev/developing-producers-with-kpl.html">KPL (Kinesis Producer Library</a> and uses the KPL built in configurations.
Copy <code>kinesis-producer-library.properties.example</code> to <code>kinesis-producer-library.properties</code> and configure the properties file to your needs.
The most important option here is configuring the region.</p>
<script>
  jQuery(document).ready(function () {
    jQuery("table").addClass("table table-condensed table-bordered table-hover");
  });
</script></div>
        </div>

        

        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>